{
  "hash": "6c2c460f8aec874a719a83dd1a1cc7cd",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Epidemic transition metrics of HIV infections estimation\"\nsubtitle: \"Dataset: Global data on HIV epidemiology and response (aidsinfo.unaids.org)\"\nexcerpt: \"\"\ndate: 2023-11-13\ndraft: false\nimages:\nseries:\ncategories:\nlayout: single\nexecute: \n  warning: false\n  message: false\n  eval: false\neditor: \n  markdown: \n    wrap: 72\n---\n\n\n\n\n\n# Overview\n\nHIV infections data is from the `aidsinfo.unaids.org`. The data contains\nGlobal values from 2010 to 2022 for `HIV estimate`,\n`HIV incidence of mortality`, `HIV prevalence`, and `HIV deaths`.\n\n![](featured.png)\n\nNational data for the 2010 and 2020 are included in this dataset.\n\nThe following is estimating magnitude of change along 10 years\ntime-frame from 2010 to 2020 of HIV infections for all countries with\navailable data.\n\nLoad necessary libraries.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(tidymodels)\ntidymodels_prefer()\nlibrary(spatialsample)\nlibrary(sf)\nlibrary(tmap)\ndata(\"World\")\n```\n:::\n\n\n\n\n\n## HIV average values (2010-2020)\n\nThis first dataset contains the average values, obtained by averaging\nthe lower and upper bounds of 2010 and 2020 HIV infections for 173\ncountries.\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\naids_avg <- read.csv(\"data/aids_avg.csv\")\naids_avg <- aids_avg%>%\n  filter(!country==\"Global\")%>%\n  filter(!country==\"India\")%>%\n  rename(aids_cc = aids_change2)\n\naids_avg%>%dim\n```\n:::\n\n\n\n\n\nThe percent change relative to the sum of changes for all countries is\ngiven by:\n\n$$\\text{Percent Change (Relative to Sum)}=(\\frac{\\text{(Final Value−Initial Value)}}{∑(Final Value−InitialValue)})×100$$\nThis will give you the\n`percent change for each country relative to the sum of all changes`. As\nwell as the\n`percentage contribution of each country's change to the total change`\ncan be obtained.\n\n## HIV Prevalence ratio (2010-2020)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprevalence_rt <- read.csv(\"data/Epidemic transition metrics_Incidence_prevalence ratio.csv\")\n\naids_prevalence_rt<-prevalence_rt%>%\n  filter(!Country==\"Global\")%>%\n  select(!contains(\"Footnote\"))%>%\n  select(contains(c(\"Country\",\"2010\",\"2020\")))%>%\n  mutate(avg_2010=(as.numeric(X2010_upper)-as.numeric(X2010_lower))/2,\n         avg_2020=(as.numeric(X2020_upper)-as.numeric(X2020_lower))/2,\n         aids_change=(avg_2020-avg_2010),\n         country_change=round(aids_change/avg_2010,5),\n         aids_prev_cc=round(aids_change/sum(aids_change,na.rm = T),5))\n```\n:::\n\n\n\n\n\n## HIV Incidence Mortality Ratio (2010-2020)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninc_mort_ratio <- read_csv(\"data/Epidemic transition metrics_Incidence_mortality ratio.csv\")\n\naids_inc_mort_ratio <- inc_mort_ratio%>%\n  janitor::clean_names()%>%\n    filter(!country==\"Global\")%>%\n  select(!contains(\"Footnote\"))%>%\n  select(contains(c(\"Country\",\"2010\",\"2020\")))%>%\n  mutate(avg_2010=(as.numeric(x2010_upper)-as.numeric(x2010_lower))/2,\n         avg_2020=(as.numeric(x2020_upper)-as.numeric(x2020_lower))/2,\n         aids_change=(avg_2020-avg_2010),\n         country_change=round(aids_change/avg_2010,5),\n         aids_imr_cc=round(aids_change/sum(aids_change,na.rm = T),5))\n```\n:::\n\n\n\n\n\n## HIV Deaths (2010-2020)\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndeaths <- read_csv(\"data/Epidemic transition metrics_Trend of AIDS-related deaths.csv\")\n\naids_deaths<- deaths%>%\n  filter(!Country==\"Global\")%>%\n  filter(!Country==\"India\")%>%\n  select(!contains(\"Footnote\"))%>%\n  select(contains(c(\"Country\",\"2010\",\"2020\")))%>%\n  janitor::clean_names()%>%\n  mutate(x2010_upper=as.numeric(str_extract(x2010_upper,\"([0-9]+)\")),\n         x2010_lower=as.numeric(str_extract(x2010_lower,\"([0-9]+)\")),\n         x2020_upper=as.numeric(str_extract(x2020_upper,\"([0-9]+)\")),\n         x2020_lower=as.numeric(str_extract(x2010_lower,\"([0-9]+)\")),\n         avg_2010=(x2010_upper-x2010_lower)/2,\n         avg_2020=(x2020_upper-x2020_lower)/2,\n         aids_change=(avg_2020-avg_2010),\n         country_change=round(aids_change/avg_2010,5),\n         aids_d_cc=round(aids_change/sum(aids_change,na.rm = T),5))\n```\n:::\n\n\n\n\n\n## All Data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat<- aids_avg%>%\n  select(country,aids_cc)%>%\n  left_join(aids_prevalence_rt%>%select(Country,aids_prev_cc),\n            by=c(\"country\"=\"Country\"))%>%\n  left_join(aids_inc_mort_ratio%>%select(country,aids_imr_cc),\n            by=c(\"country\"))%>%\n  left_join(aids_deaths%>%select(country,aids_d_cc),\n            by=c(\"country\"))\ndat%>%head\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndat%>%\n  dim()\n```\n:::\n\n\n\n\n\n### Barplot\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndat%>%\n  pivot_longer(cols = contains(\"cc\"))%>%\n  mutate(value=scale(value),\n         country=as.factor(country))%>%\n  drop_na()%>%\n  ggplot(aes(x=fct_reorder(country,value),y=value,\n             group=name,fill=name),color=\"grey24\")+\n  geom_col(position = \"stack\")+\n  scale_y_log10(expand=c(0,0),label=scales::comma_format())+\n  labs(title=\"HIV Distributions (2010-2020)\",\n       x=\"Country\",\n       fill=\"\",\n       caption = \"Graphic: @fgazzelloni\")+\n  theme(text=element_text(size=14),\n        axis.text.x = element_text(angle = 90,size=4,hjust=1),\n        panel.grid = element_blank(),\n        panel.background = element_rect(color = \"grey24\",fill=\"grey24\"))\n```\n:::\n\n\n\n\n\n## World Polygons\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nWorld <- World %>%\n  select(country=name,geometry)%>%\n  filter(!country==\"Antarctica\")\n\naids_map <- dat%>%\n    pivot_longer(cols = contains(\"cc\"))%>%\n  mutate(value=scale(value),\n         country=as.factor(country))%>%\n  drop_na()%>%\n  left_join(World,by=\"country\")%>%\n  st_as_sf()%>%\n  st_transform(crs=\"ESRI:54030\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlabels=c(\"aids_cc\"=\"HIV Country Contribution\",\n         \"aids_d_cc\"=\"HIV Deaths Country Contribution\",\n         \"aids_imr_cc\"=\"HIV incidence mortality rate Country Contribution\",\n         \"aids_prev_cc\"=\"HIV Prevalence Country Contribution\")\n```\n:::\n\n\n\n\n\n### Global HIV Map\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot()+\n  geom_sf(data=World,color=\"grey25\",fill=\"grey75\")+\n  geom_sf(data=aids_map,\n          mapping=aes(geometry=geometry,fill=value),\n          color=\"red\")+\n  coord_sf(crs=\"ESRI:54030\",clip = \"off\")+\n  facet_wrap(~name,labeller = labeller(name=labels))+\n  scale_fill_viridis_c()+\n  labs(caption=\"Map: @fgazzelloni\")\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n## Spending Data\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndata <- dat%>%\n  drop_na()%>%\n  inner_join(World,by=c(\"country\"))%>%\n  sf::st_as_sf(crs = 4326)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(11132023)\nsplit <- initial_split(data,prop = 0.8)\ntrain<- training(split)\ntest <- testing(split)\n```\n:::\n\n\n\n\n\n## Spatial Cross validation\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfolds <- spatial_clustering_cv(train, v = 5)\n```\n:::\n\n\n\n\n\n### Mapping Spatial Clusters\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nautoplot(folds)+\n  labs(title=\"HIV Spatial Clustering Cross Validation\",\n       caption=\"DataSource: aidsinfo.unaids.org | Map: @fgazzelloni\")+\n  ggthemes::theme_map(base_size = 14)+\n  theme(plot.title = element_text(hjust=0.5),\n        plot.caption = element_text(hjust = 0.5))\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n\n\n\n## Function for calculating Predictions\n\nsource:\n<https://spatialsample.tidymodels.org/articles/spatialsample.html>\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# `splits` will be the `rsplit` object\ncompute_preds <- function(splits) {\n  # fit the model to the analysis set\n  mod <- lm(aids_cc ~ aids_prev_cc+aids_imr_cc+aids_d_cc,\n    data = analysis(split)\n  )\n  # identify the assessment set\n  holdout <- assessment(split)\n  # return the assessment set, with true and predicted price\n  tibble::tibble(\n    geometry = holdout$geometry,\n    aids_cc = log10(holdout$aids_cc),\n    .pred = predict(mod, holdout)\n  )\n}\n```\n:::\n\n\n\n\n\n## Spatial Clustering and Spatial Block cross validations\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncluster_folds <- spatial_clustering_cv(data, v = 15)\nblock_folds <- spatial_block_cv(data, v = 15)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncluster_folds$type <- \"cluster\"\nblock_folds$type <- \"block\"\n\n\nresamples <-\n  dplyr::bind_rows(\n    cluster_folds,\n    block_folds\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_res <- resamples %>%\n  mutate(.preds = map(splits, compute_preds))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_rmse <- cv_res %>%\n  unnest(.preds) %>%\n  drop_na()%>%\n  filter(!aids_cc==-Inf)%>%\n  group_by(id, type) %>%\n  rmse(aids_cc, .pred)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_res %>%\n  unnest(.preds) %>%\n  ggplot(aes(fill = .pred)) +\n  geom_sf(data=World,mapping=aes(geometry = geometry),inherit.aes = F)+\n  geom_sf(aes(geometry = geometry)) +\n  labs() +\n  scale_fill_viridis_c() +\n  facet_wrap(~type)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ncv_res %>%\n  unnest(.preds) %>%\n  ggplot(aes(fill = aids_cc)) +\n  geom_sf(data=World,mapping=aes(geometry = geometry),inherit.aes = F)+\n  geom_sf(aes(geometry = geometry)) +\n  labs() +\n  scale_fill_viridis_c() \n```\n:::\n\n\n\n\n\n## References\n\n-   [SpatialSample](https://spatialsample.tidymodels.org/articles/spatialsample.html)\n-   [r-spatial.org](https://r-spatial.org/book/14-Areal.html#contiguous-neighbours)\n-   <https://www.tmwr.org/>\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}