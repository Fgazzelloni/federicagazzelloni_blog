{
  "hash": "88d213b73eca89e778e902fd6791f9f8",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"The case of Malaria\"\nexcerpt: \"\"\ndate: 2023-08-27\ndraft: false\nimages:\nseries:\ncategories:\nlayout: single\nexecute: \n  eval: false\n---\n\n\n## Overview\n\n> August 18, 2023 \"A case of locally acquired #malaria has been confirmed in Maryland, Washington, D.C., area. Nine cases have been reported this summer in Florida and Texas, the first in the US in 20 years, according to the US Centers for Disease Control and Prevention. #epidemics\" [^1]\n\n[^1]: worldbank_data source: <https://databank.worldbank.org/reports.aspx?source=2&series=SH.MLR.INCD.P3&country=#>\n\n![](featured.png)\n\nThe Malaria case is somehow a concerning case, eradicated all over the World except for some areas in the Africa's continent, the highlight of cases of domestic origins are considered epidemics.\n\nLet's dig on some data about Malaria.\n\n## WHO Malaria Map\n\nThe first source of data is the [WHO Malaria Map](https://bit.ly/3OUhT1x), a collection of information about location of cases, the vector species, their invasive status, and other variables of interest such as temporal of the study, the sampling methods, and so on.\n\nLoad necessary libraries\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(readxl)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who <- read_excel(\"data/who_data.xlsx\", \n    sheet = \"Data\")\nmalaria_who %>% head()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndim(malaria_who)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who%>%glimpse\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who <- malaria_who %>%\n  janitor::clean_names() %>%\n  mutate(longitude=as.double(longitude),latitude=as.double(latitude))\n```\n:::\n\n\n\n\nHistorical collection of data about mosquito number shows data is collected from 1985 and updated to 2022.\n\n\n::: {.cell}\n\n:::\n\n\nLet's omit missing values for the `year_start` variable and create a new variable `midyear` which is the middle year between the `year_start` and `year_end` of each study.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who_mid_year <- malaria_who %>%\n  filter(!is.na(year_start),\n         !is.na(year_end),\n         !is.na(mosquito_number),\n         !mosquito_number==\"NR\") %>%\n  mutate(mosquito_number=as.numeric(mosquito_number),\n         year_end=as.double(year_end),\n         midyear=round((year_end+year_start)/2,0))\n```\n:::\n\n\nAlong the time, the trend of the number of mosquito varied with ups and downs.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who_mid_year %>%\ngroup_by(midyear)%>%# count(midyear)\n  mutate(avg_n_mosquito=mean(mosquito_number))%>%\n  ungroup()%>%\n  count(country_name,midyear,avg_n_mosquito,invasive_status)%>%\n  ggplot(aes(x=midyear,y=log10(avg_n_mosquito),\n             group=invasive_status,color=invasive_status))+\n  geom_line(linewidth=2)+\n  scale_color_viridis_d(labels = c(\"Invasive\", \"Native\"),\n                       guide = guide_legend(reverse=TRUE,\n                                            override.aes = list(size = 10)))+\n  coord_cartesian(clip = 'off') +\n  labs(title=\"Time series Malaria 1985 - 2022\",\n       caption=\"Graphics: FG\",color=\"Status\")+ \n  ggthemes::theme_fivethirtyeight()\n```\n:::\n\n\nMosquito have been categorized as `invasive species`, after 2016.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_who_mid_year%>%\n  filter(midyear>= 2010)%>%\n  ggplot(aes(x=factor(midyear),y=log10(mosquito_number),\n             group=midyear,fill=invasive_status))+\n  geom_violin()+\n  scale_fill_viridis_d(labels = c(\"Invasive\", \"Native\"),\n                       guide = guide_legend(reverse=TRUE,\n                                            override.aes = list(size = 10)))+\n  ggthemes::theme_fivethirtyeight()+\n  theme(legend.position = \"top\")+\n  labs(title=\"When moqsquito became tag invasive\",\n       caption=\"Graphics: FG\",fill=\"Status\")\n```\n:::\n\n\nThe location of cases revealed by consistent `sentinel surveillance` procedure, identify the area in the south est Africa/Asia to be the most affected by the danger of malaria virus to spread across the rest of the World.\n\nHere is a map of the `invasive vector species` in this area:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nworld <- map_data(\"world\")%>%filter(!region==\"Antarctica\")\n\nmalaria_who %>%\n  ggplot(mapping=aes(x=longitude,y=latitude))+\n  geom_polygon(data=world,\n               mapping=aes(x=long,y=lat,group=group),\n               linewidth=0.2,\n               color=\"grey80\",\n               fill=\"white\")+\n  geom_point(aes(fill=invasive_status),\n             color=\"grey80\",\n             shape=21,\n             stroke=0.2,\n             size=0.7,alpha=0.5)+\n  coord_sf(xlim = c(-50, 110), expand = TRUE) +\n  scale_fill_viridis_d()+\n  labs(title=\"Invasive vector species from 1985 to 2022\",fill=\"Status\")+\n  ggthemes::theme_map()+\n  theme(plot.background = element_rect(color=\"steelblue\",fill=\"steelblue\"))\n```\n:::\n\n\nLet's zoom in to the center of the mass points. Setting the mean range of the latitude and the longitude, to identify the central point, within the mass of points where mosquito were located, and setting a zoom level, a closer focus at the locations is possible, even with a specification of the new range of to be assigned to the map boundaries.[^2]\n\n[^2]: worldbank_data source: <https://databank.worldbank.org/reports.aspx?source=2&series=SH.MLR.INCD.P3&country=#>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlon_avg <- mean(range(malaria_who$longitude))\nlat_avg <- mean(range(malaria_who$latitude))\nlon_avg;lat_avg\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nzoom_to <- c(lon_avg,lat_avg)  \n\nzoom_level <- 1.5\n\nlon_span <- 360 / 2^zoom_level\nlat_span <- 180 / 2^zoom_level\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlon_bounds <- c(zoom_to[1] - lon_span / 2, zoom_to[1] + lon_span / 2)\nlat_bounds <- c(zoom_to[2] - lat_span / 2, zoom_to[2] + lat_span / 2)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(sf)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot()+\n  geom_polygon(data=world,\n               mapping=aes(x=long,y=lat,group=group),\n               linewidth=0.2,\n               color=\"grey80\",\n               fill=\"white\")+\n  geom_point(data= malaria_who,\n             mapping=aes(x=longitude,y=latitude,\n                         fill=invasive_status),\n             color=\"black\",\n             shape=21,\n             stroke=0.2,\n             size=3,alpha=0.5)+\n  geom_sf_text(data = st_sfc(st_point(zoom_to), crs = 4326),\n            label = '.') +\n  scale_fill_viridis_d()+\n  coord_sf(xlim = lon_bounds, ylim = lat_bounds,expand = TRUE) + \n  labs(title=\"A closer look at invasive vector species\",\n      subtitle=\"from 1985 to 2022\",\n       caption=\"DataSource: WHO Malaria Data | Graphics: FG\",\n       fill=\"Status\")+\n  ggthemes::theme_map()+\n  theme(text=element_text(family=\"Roboto Condensed\"),\n        plot.title = element_text(size = 18),\n        plot.background = element_rect(color=\"steelblue\",fill=\"steelblue\"),\n        legend.position = c(0,0.001))\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n## Incidence of malaria\n\nLooking at a different data source, the `Worldbank data` provides a reports with the `incidence of malaria` from 2000 and 2010. [^3]\n\n[^3]: worldbank_data source: <https://databank.worldbank.org/reports.aspx?source=2&series=SH.MLR.INCD.P3&country=#>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_wb <- read_csv(\"data/worldbank_data.csv\")\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_wb_long <- malaria_wb%>%\n  janitor::clean_names()%>%\n  select(-series_name,-series_code) %>%\n  pivot_longer(cols = c(3:14),names_to=\"year\")%>%\n  mutate(value=trimws(value),\n         value=as.numeric(value),\n         value=round(value,3))%>%\n  filter(!is.na(value))%>%\n  mutate(year=gsub(\"_yr[0-9]+$\",\"\",year),\n         year=gsub(\"^x\",\"\",year),\n         year=as.integer(year))%>%\n  arrange(year)\nmalaria_wb_long%>%glimpse\n```\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmalaria_wb_long%>%\n  group_by(year)%>%\n  reframe(avg=mean(value))%>%\n  mutate(year=as.factor(year))%>%\n  ggplot(aes(year,avg,group=1))+\n  #geom_col()+ \n  geom_line()+\n  labs(title=\"Incidence of Malaria\",\n  subtitle=\"per 1,000 population at risk\",\n  caption = \"Graphics: FG\")+\n  ggthemes::theme_fivethirtyeight()\n```\n:::\n\n\n\n\n\n\n## Case Study - antimalarial drug resistance\n\n#### Tracking antimalarial drug resistance using mosquito blood meals: a cross-sectional study\n\n-   Article: <https://www.thelancet.com/journals/lanmic/article/PIIS2666-5247(23)00063-0/fulltext>\n\n-   GitHub repository: <https://github.com/hannaehrlich/maldrugres_SSA>\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"https://raw.githubusercontent.com/hannaehrlich/maldrugres_SSA/main/Survey_MolecMarker_Data.csv\"\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres <- read.csv(url)\nnames(maldrugres)\n```\n:::\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres <- maldrugres %>%\n  filter(!is.na(Lat),!is.na(Drug),!Drug==\"\")\n\nmaldrugres%>%count(Drug)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nworld <- map_data(\"world\")%>%filter(!region==\"Antarctica\")\nafrica <- world%>%filter(long >= -50,long< 60)\n\nggplot(data= maldrugres) +\n  geom_polygon(data= africa, \n               mapping=aes(x=long,y=lat,group=group),\n               linewidth=0.1,\n               color=\"grey70\",fill=\"grey90\")+\n  geom_point(mapping=aes(x=Lon,y=Lat,\n                         color=Drug,\n                         fill=Present),\n             shape=21,\n             stroke=0.2,\n             size=3)+\n  scale_color_manual(values = c(\"steelblue\",\"darkred\"))+\n  scale_fill_gradient(low=NA,high = \"darkred\")+\n  coord_sf(xlim = c(-20,50),ylim = c(-40,60),clip = \"off\")+\n    labs(title=\"antiMalarial drug resistance\",\n       caption=\"DataSource: GitHub hannaehrlich/maldrugres_SSA | Graphics: FG\")+\n  ggthemes::theme_map()+\n  theme(text = element_text(family=\"Roboto Condensed\"),\n        plot.title = element_text(size=30,hjust = 0.5,family=\"Roboto Condensed\"),\n        plot.title.position = \"plot\",\n        legend.position = c(-0.6,0.1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres_new <- maldrugres%>%\n  mutate(MidYear = round((StartYr+EndYr)/2,0),\n         MidYear= as.factor(MidYear))%>%\n  select(Country,Site,Lon,Lat,MidYear,Tested,Present,MixedPres,Drug)%>%\n  janitor::clean_names()\n\nmaldrugres_new%>%head\n```\n:::\n\n\n### Tidymodels\n\n#### EDA\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres_new%>%\n  count(drug)%>%\n  ggplot(aes(x=drug,y=n,fill=drug))+\n  geom_col()+\n  labs(title=\"Drug class imbalance\",\n       caption=\"Graphics: FG\")+\n  scale_fill_viridis_d()+\n  ggthemes::theme_fivethirtyeight()+\n  theme(legend.position = \"none\")\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres_new%>%\n  group_by(country,drug)%>%\n  reframe(avg_drug=mean(present))%>%\n  ggplot(aes(x=avg_drug,y=fct_reorder(country,avg_drug)))+\n  geom_col(aes(fill=drug))+\n  scale_fill_viridis_d()+\n  labs(title=\"AntiMalarial Drug Resistance Present\",\n       caption=\"Graphics: FG\",\n       x=\"Average value by Country\",y=\"\")+\n   ggthemes::theme_fivethirtyeight()+\n  theme(axis.text.x = element_text(angle=0,hjust = 1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres_new %>%\n  ggplot(aes(present))+\n  geom_density()+\n  labs(title=\"Density distribution of antimalarial drug resistance\",\n       caption = \"Graphics: FG\")+\n  ggthemes::theme_fivethirtyeight()\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmaldrugres_new%>%\n  group_by(country,drug)%>%\n  reframe(avg_drug=mean(present))%>%\n  ggplot(aes(x=avg_drug,y=fct_reorder(country,avg_drug)))+\n  geom_boxplot()+\n  labs(title=\"AntiMalaria Drug Resistance Present\",\n       caption=\"Graphics: FG\",\n       x=\"Average value by Country\",y=\"\")+\n  theme(axis.text.x = element_text(angle=0,hjust = 1))+\n  ggthemes::theme_fivethirtyeight()\n```\n:::\n\n\n### Spending data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidymodels)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(123)\nsplit <- initial_split(maldrugres_new)\ntraining <- training(split)\ntesting <- testing(split)\ncv_folds <- vfold_cv(training,v = 10)\n```\n:::\n\n\n### Featuring Engineering\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_pca <- recipe(present ~., training) %>%\n  step_dummy(all_nominal_predictors(),keep_original_cols = F)%>%\n  step_corr(all_numeric_predictors())%>%\n  step_normalize(all_predictors())%>%\n  step_pca(all_predictors())\n  \nrec_pca_df <- rec_pca %>%\nprep()%>%\n  juice()%>%\n  cbind(drug=training$drug,country=training$country)\nrec_pca_df%>%head\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_pca_df %>%\nggplot(aes(x=PC1,PC2,group=drug,color=drug))+\n  geom_point()+\n  geom_smooth(se=F)+\n  scale_color_viridis_d()+\n  labs(title=\"Principal Components Analysis\",\n       caption = \"Graphics: FG\")+\n  ggthemes::theme_fivethirtyeight()+\n  theme(axis.title = element_text())\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_pca_df %>%\nggplot(aes(x=PC1,y=fct_reorder(country,PC1),group=country))+\n  geom_boxplot()+\n  labs(title=\"Principal Components Analysis - boxplot\",\n       caption = \"Graphics: FG\",y=\"\")+\n  ggthemes::theme_fivethirtyeight()+\n    theme(axis.title = element_text(),\n          plot.title = element_text(hjust = 1))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_pca_df %>%\nggplot(aes(x=PC1,y=present))+\n  geom_point()+\n  scale_y_log10()+\n  geom_smooth(method = 'gam', formula = y ~ s(x, bs = \"cs\"))+\n  labs(title=\"Principal Components Analysis - scatterplot\",\n       caption = \"Graphics: FG\",y=\"Present\")+\n  ggthemes::theme_fivethirtyeight()+\n    theme(axis.title = element_text(),\n          plot.title = element_text(hjust = 0))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_ica <- recipe(present ~., training) %>%\n  step_dummy(all_nominal_predictors(),keep_original_cols = F)%>%\n  step_corr(all_numeric_predictors())%>%\n  step_normalize(all_predictors())%>%\n  step_ica(all_predictors())%>%\n  prep()%>%\n  juice()%>%\n  cbind(drug=training$drug)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nrec_ica %>%\nggplot(aes(x=IC1,IC2,group=drug,color=drug))+\n  geom_point()+\n  geom_smooth(se=F)+\n  scale_colour_viridis_d()+\n  labs(title=\"Independent Components Analysis\",\n       caption = \"Graphics: FG\")+\n  ggthemes::theme_fivethirtyeight()+\n    theme(axis.title = element_text(),\n          plot.title = element_text(hjust = 0))\n```\n:::\n\n::: {.cell}\n\n:::\n\n\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}